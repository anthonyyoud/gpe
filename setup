#!/bin/bash
# Compile and set up the code ready to run in a separate directory
# usage:  ./setup <directory name>

mkdir $1 2> /dev/null

# Determine whether this run will be for filtered isosurfaces
filter=`cat parameters.f90 | grep pp_filter | cut -c 47-`
if [ $filter == '.false.' ]; then
  echo FILTER will be set to 0
  sed -i s/FILTER\=[01]/FILTER\=0/ run_script.sh
elif [ $filter == '.true.' ]; then
  echo FILTER will be set to 1
  sed -i s/FILTER\=[01]/FILTER\=1/ run_script.sh
else
  echo ERROR: \$filter does not match one of .true. or .false.
  return 1
fi

#Compile.  Set j=nprocs+1 for efficient parallel make.
make -j 3

#Setup dir
if [ $? == 0 ]; then
  mv gpe $1
  cp parameters.f90 $1
  #cp run_script.sh $1
  cp run_script_quantum.sh $1
  cp condor_mpi.sh $1
  #cp transfer.sh $1
  #cp ulimit_hack.sh $1
  cd $1
fi
